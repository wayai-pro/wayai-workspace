# Workspace Format (HubAsCode)

Conventions for the workspace directory structure and `wayai.yaml` configuration format.

## Table of Contents
- [Directory Structure](#directory-structure)
- [Slugification Rules](#slugification-rules)
- [wayai.yaml Structure](#wayaiyaml-structure)
- [Agent Instructions](#agent-instructions)
- [Custom Tool Definition](#custom-tool-definition)
- [Download Workflow](#download-workflow)
- [Sync via GitOps](#sync-via-gitops)

## Directory Structure

```
workspace/                                # Workspace folder (from download_workspace)
├── workspace.md                          # Workspace overview (orgs/projects/hubs index)
├── last-sync.md                          # Sync metadata
└── {org-slug}/                           # Organization folder
    └── {project-slug}/                   # Project folder
        └── {hub-slug}/                   # Hub folder
            ├── wayai.yaml                # Hub config + agents + tools + states
            ├── agents/                   # Agent instruction files
            │   ├── pilot.md              # Instructions for "Pilot Agent"
            │   └── specialist-billing.md # Instructions for "Specialist - Billing"
            ├── CONTEXT.md                # Living notes (NOT synced to backend)
            └── references/               # Supporting files (NOT synced to backend)
```

## Slugification Rules

Convert names to URL-safe slugs:

| Original | Slug |
|----------|------|
| `Mario's Pizza` | `marios-pizza` |
| `Pilot Agent` | `pilot-agent` |
| `Specialist - Billing` | `specialist-billing` |
| `Suporte Nível 2` | `suporte-nivel-2` |
| `Support Hub 2.0` | `support-hub-20` |

Rules:
1. Lowercase
2. Normalize accents (NFD + strip diacritics)
3. Replace non-alphanumeric with hyphens
4. Collapse consecutive hyphens
5. Remove leading/trailing hyphens
6. Limit to 50 characters

## wayai.yaml Structure

Hub configuration is stored as structured YAML. The file has these top-level sections:

```yaml
version: 1

# Read-only metadata (set by download_workspace, do not edit)
hub_id: "abc-123-def"
hub_environment: production    # preview | production

hub:
  name: Customer Support
  description: AI-powered support hub
  hub_type: user               # user | workflow
  ai_mode: Pilot+Copilot      # Pilot | Copilot | Pilot+Copilot | Turned Off
  timezone: America/New_York
  app_permission: require_permission
  non_app_permission: not_allowed
  mcp_access: read_only        # disabled | read_only | read_write
  file_handling_mode: metadata_only
  max_file_size_for_attachment: 10485760
  inactivity_interval: 30
  followup_message: "Is there anything else I can help with?"
  hub_sla:
    time_threshold1: 60
    time_threshold2: 300
    time_threshold3: 600
  kanban_statuses:
    - name: New
    - name: In Progress
    - name: Resolved

agents:
  - name: Pilot Agent
    role: Pilot
    connection: anthropic             # connection display name (must exist on hub)
    instructions: agents/pilot.md     # relative path to .md file
    enabled: true
    include_message_timestamps: false
    settings:
      model: claude-sonnet-4-20250514
      temperature: 0.7
      max_tokens: 4096
    tools:
      native:
        - send_text_message
        - update_kanban_status
      delegation:
        - type: agent
          tool: transfer_to_agent
          target: Specialist - Billing
        - type: team
          tool: transfer_to_team
          target: Tier 2 Support
      custom:
        - name: check_order_status
          description: Check order status by email
          method: post
          path: /api/orders/status
          body_format: json
          connection: my-api-connection

states:
  - name: order_tracking
    scope: conversation          # conversation | user
    description: Tracks current order
    enabled: true
    json_schema:
      type: object
      properties:
        order_id: { type: string }
        status: { type: string, enum: [pending, shipped, delivered] }
    initial_value: { order_id: null, status: null }

# Read-only reference (generated by download, not synced back)
connections:
  - name: anthropic
    type: Agent
    service: Anthropic
  - name: my-api-connection
    type: Tool - Custom
```

### Key rules

- **`hub_id`** and **`hub_environment`** are read-only — do not edit
- **Agents** reference connections by `connection` display name (must match a connection on the hub)
- **Tools** are grouped as `native` (by tool name), `delegation` (agent or team), and `custom` (HTTP endpoints)
- **States** are matched by `name` + `scope` (unique per hub)
- **Default omission:** Fields matching defaults are omitted to keep YAML concise (e.g., `enabled: true` is default, only `enabled: false` appears)
- **Connections section** is read-only reference — adding/removing connections is done via UI or MCP

### Entity matching (for sync/diff)

| Entity | Matched by |
|--------|------------|
| Agent | `name` (unique per hub) |
| State | `name` + `scope` |
| Native tool | `tool_name` (per agent) |
| Custom tool | `name` (per agent) |
| Delegation tool | `target` name (per agent) |

## Agent Instructions

Agent instructions are stored in separate `.md` files under `agents/` for easier editing and diff-friendly PRs:

- **Path convention:** `agents/{slugified-agent-name}.md`
- **Referenced from wayai.yaml:** `instructions: agents/pilot.md`
- **Content:** Pure instruction text (no frontmatter, no metadata)
- Supports dynamic placeholders: `{{now()}}`, `{{user_name()}}`, `{{state()}}`, etc. — see [agent-placeholders.md](agent-placeholders.md)

## Custom Tool Definition

Custom tools in `wayai.yaml` under each agent's `tools.custom`:

```yaml
agents:
  - name: Order Agent
    tools:
      custom:
        - name: create_order
          description: Creates a new order
          method: POST
          path: /api/orders
          body_format: json
          connection: my-api-connection
          tool_instructions: "Use when the customer wants to place a new order"
        - name: get_menu
          description: Retrieves menu items
          method: GET
          path: /api/menu
          connection: my-api-connection
```

| Field | Type | Description |
|-------|------|-------------|
| `name` | string | Tool name (snake_case recommended) |
| `description` | string | What the tool does (for AI) |
| `method` | enum | HTTP method: GET, POST, PUT, DELETE, PATCH |
| `path` | string | URL path (appended to connection base URL) |
| `body_format` | string | `json` or `form` |
| `connection` | string | Display name of the Tool - Custom connection |
| `tool_instructions` | string | Usage instructions for the AI |

## Download Workflow

### Using download_workspace (Recommended)

```
1. download_workspace() → download URL
2. Download and extract zip
3. Replace local workspace folders
4. git diff to review
5. git commit
```

### Downloading Agent Instructions

```
1. download_agent_instructions(hub_id, agent_id) → signed download URL
2. curl -L "{url}" -o workspace/{org}/{project}/{hub}/agents/{agentname}.md
3. Read the workspace file when needed
```

## Sync via GitOps

For production hubs with `mcp_access: read_only`, configuration changes flow through git:

```
1. Edit wayai.yaml and/or agents/*.md locally
2. Create a PR → GitHub Action creates branch preview per changed production hub
3. Test the preview hub(s)
4. Merge the PR → GitHub Action syncs and publishes to production
```

The GitHub Action (`.github/actions/wayai-sync/`) parses `wayai.yaml`, reads `agents/*.md` contents, and calls the CI API endpoints to apply changes.

## Key Principle

**Platform is the source of truth.** Workspace files are structured mirrors for agent context, user review, and git history. Always sync from platform before making changes.
